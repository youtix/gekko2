import { describe, expect, it } from 'vitest';
import { CCI } from './cci.indicator';

describe('CCI', () => {
  describe('period 8', () => {
    // Create one CCI instance with history = 8.
    const cci = new CCI({ history: 8, constant: 0.015 });
    // For each candle (indexed from 0 to 38), feed the data and check the result.
    it.each`
      index | high   | low   | close | verified
      ${0}  | ${86}  | ${1}  | ${81} | ${NaN}
      ${1}  | ${85}  | ${5}  | ${24} | ${NaN}
      ${2}  | ${90}  | ${14} | ${75} | ${NaN}
      ${3}  | ${95}  | ${10} | ${21} | ${NaN}
      ${4}  | ${58}  | ${20} | ${34} | ${NaN}
      ${5}  | ${71}  | ${10} | ${25} | ${NaN}
      ${6}  | ${84}  | ${1}  | ${72} | ${NaN}
      ${7}  | ${98}  | ${48} | ${92} | ${165.258216}
      ${8}  | ${99}  | ${64} | ${99} | ${137.978495}
      ${9}  | ${100} | ${0}  | ${2}  | ${-78.352249}
      ${10} | ${91}  | ${0}  | ${86} | ${23.011844}
      ${11} | ${95}  | ${50} | ${80} | ${66.039216}
      ${12} | ${99}  | ${15} | ${76} | ${11.260054}
      ${13} | ${96}  | ${0}  | ${8}  | ${-110.755556}
      ${14} | ${96}  | ${4}  | ${87} | ${2.108795}
      ${15} | ${90}  | ${57} | ${75} | ${60.958054}
      ${16} | ${79}  | ${1}  | ${32} | ${-79.830149}
      ${17} | ${72}  | ${11} | ${65} | ${-40.800225}
      ${18} | ${91}  | ${9}  | ${41} | ${-42.00627}
      ${19} | ${81}  | ${1}  | ${9}  | ${-103.175918}
      ${20} | ${94}  | ${1}  | ${13} | ${-58.657244}
      ${21} | ${87}  | ${10} | ${26} | ${-37.232704}
      ${22} | ${60}  | ${25} | ${56} | ${12.844037}
      ${23} | ${93}  | ${11} | ${28} | ${31.25}
      ${24} | ${75}  | ${16} | ${65} | ${101.960784}
      ${25} | ${94}  | ${50} | ${58} | ${187.096774}
      ${26} | ${75}  | ${7}  | ${17} | ${-82.539683}
      ${27} | ${93}  | ${13} | ${90} | ${114.047867}
      ${28} | ${92}  | ${74} | ${87} | ${147.875064}
      ${29} | ${92}  | ${71} | ${86} | ${101.075269}
      ${30} | ${99}  | ${59} | ${99} | ${88.888889}
      ${31} | ${99}  | ${3}  | ${3}  | ${-108.039098}
      ${32} | ${84}  | ${1}  | ${70} | ${-43.914081}
      ${33} | ${91}  | ${1}  | ${1}  | ${-87.872763}
      ${34} | ${27}  | ${0}  | ${27} | ${-113.138686}
      ${35} | ${67}  | ${5}  | ${9}  | ${-68.525669}
      ${36} | ${97}  | ${1}  | ${92} | ${43.243243}
      ${37} | ${92}  | ${60} | ${68} | ${82.481254}
      ${38} | ${89}  | ${6}  | ${9}  | ${-29.942756}
    `('candle #$index: expected $verified', ({ high, low, close, verified }) => {
      cci.onNewCandle({ high, low, close });
      const result = cci.getResult();
      if (isNaN(result) && isNaN(verified)) {
        expect(result).toBeNaN();
      } else {
        expect(result.toFixed(6)).toEqual(verified.toFixed(6));
      }
    });
  });

  describe('period 10', () => {
    const cci = new CCI({ history: 10, constant: 0.015 });
    it.each`
      index | high   | low   | close | verified
      ${0}  | ${86}  | ${1}  | ${81} | ${NaN}
      ${1}  | ${85}  | ${5}  | ${24} | ${NaN}
      ${2}  | ${90}  | ${14} | ${75} | ${NaN}
      ${3}  | ${95}  | ${10} | ${21} | ${NaN}
      ${4}  | ${58}  | ${20} | ${34} | ${NaN}
      ${5}  | ${71}  | ${10} | ${25} | ${NaN}
      ${6}  | ${84}  | ${1}  | ${72} | ${NaN}
      ${7}  | ${98}  | ${48} | ${92} | ${NaN}
      ${8}  | ${99}  | ${64} | ${99} | ${NaN}
      ${9}  | ${100} | ${0}  | ${2}  | ${-81.681682}
      ${10} | ${91}  | ${0}  | ${86} | ${28.953557}
      ${11} | ${95}  | ${50} | ${80} | ${78.940028}
      ${12} | ${99}  | ${15} | ${76} | ${27.948194}
      ${13} | ${96}  | ${0}  | ${8}  | ${-82.58317}
      ${14} | ${96}  | ${4}  | ${87} | ${17.665798}
      ${15} | ${90}  | ${57} | ${75} | ${57.71725}
      ${16} | ${79}  | ${1}  | ${32} | ${-100.171969}
      ${17} | ${72}  | ${11} | ${65} | ${-36.79078}
      ${18} | ${91}  | ${9}  | ${41} | ${-33.502538}
      ${19} | ${81}  | ${1}  | ${9}  | ${-113.08642}
      ${20} | ${94}  | ${1}  | ${13} | ${-70.175439}
      ${21} | ${87}  | ${10} | ${26} | ${-36.995092}
      ${22} | ${60}  | ${25} | ${56} | ${7.30897}
      ${23} | ${93}  | ${11} | ${28} | ${-20.757021}
      ${24} | ${75}  | ${16} | ${65} | ${51.239669}
      ${25} | ${94}  | ${50} | ${58} | ${200}
      ${26} | ${75}  | ${7}  | ${17} | ${-99.574468}
      ${27} | ${93}  | ${13} | ${90} | ${134.51119}
      ${28} | ${92}  | ${74} | ${87} | ${166.021297}
      ${29} | ${92}  | ${71} | ${86} | ${117.174281}
      ${30} | ${99}  | ${59} | ${99} | ${100.395257}
      ${31} | ${99}  | ${3}  | ${3}  | ${-94.147583}
      ${32} | ${84}  | ${1}  | ${70} | ${-33.202614}
      ${33} | ${91}  | ${1}  | ${1}  | ${-101.396478}
      ${34} | ${27}  | ${0}  | ${27} | ${-115.00256}
      ${35} | ${67}  | ${5}  | ${9}  | ${-71.976401}
      ${36} | ${97}  | ${1}  | ${92} | ${27.092846}
      ${37} | ${92}  | ${60} | ${68} | ${53.157122}
      ${38} | ${89}  | ${6}  | ${9}  | ${-49.211356}
    `('candle #$index: expected $verified', ({ high, low, close, verified }) => {
      cci.onNewCandle({ high, low, close });
      const result = cci.getResult();
      if (isNaN(result) && isNaN(verified)) {
        expect(result).toBeNaN();
      } else {
        expect(result.toFixed(6)).toEqual(verified.toFixed(6));
      }
    });
  });

  describe('period 12', () => {
    const cci = new CCI({ history: 12, constant: 0.015 });
    it.each`
      index | high   | low   | close | verified
      ${0}  | ${86}  | ${1}  | ${81} | ${NaN}
      ${1}  | ${85}  | ${5}  | ${24} | ${NaN}
      ${2}  | ${90}  | ${14} | ${75} | ${NaN}
      ${3}  | ${95}  | ${10} | ${21} | ${NaN}
      ${4}  | ${58}  | ${20} | ${34} | ${NaN}
      ${5}  | ${71}  | ${10} | ${25} | ${NaN}
      ${6}  | ${84}  | ${1}  | ${72} | ${NaN}
      ${7}  | ${98}  | ${48} | ${92} | ${NaN}
      ${8}  | ${99}  | ${64} | ${99} | ${NaN}
      ${9}  | ${100} | ${0}  | ${2}  | ${NaN}
      ${10} | ${91}  | ${0}  | ${86} | ${NaN}
      ${11} | ${95}  | ${50} | ${80} | ${91.97995}
      ${12} | ${99}  | ${15} | ${76} | ${35.138387}
      ${13} | ${96}  | ${0}  | ${8}  | ${-86.288416}
      ${14} | ${96}  | ${4}  | ${87} | ${30.06993}
      ${15} | ${90}  | ${57} | ${75} | ${67.713787}
      ${16} | ${79}  | ${1}  | ${32} | ${-85.863874}
      ${17} | ${72}  | ${11} | ${65} | ${-44.274809}
      ${18} | ${91}  | ${9}  | ${41} | ${-51.105651}
      ${19} | ${81}  | ${1}  | ${9}  | ${-102.536873}
      ${20} | ${94}  | ${1}  | ${13} | ${-68.659725}
      ${21} | ${87}  | ${10} | ${26} | ${-49.02507}
      ${22} | ${60}  | ${25} | ${56} | ${-14.705882}
      ${23} | ${93}  | ${11} | ${28} | ${-21.217712}
      ${24} | ${75}  | ${16} | ${65} | ${42.461538}
      ${25} | ${94}  | ${50} | ${58} | ${122.124711}
      ${26} | ${75}  | ${7}  | ${17} | ${-94.10628}
      ${27} | ${93}  | ${13} | ${90} | ${146.91745}
      ${28} | ${92}  | ${74} | ${87} | ${197.464342}
      ${29} | ${92}  | ${71} | ${86} | ${135.599506}
      ${30} | ${99}  | ${59} | ${99} | ${111.925175}
      ${31} | ${99}  | ${3}  | ${3}  | ${-80.55041}
      ${32} | ${84}  | ${1}  | ${70} | ${-23.476298}
      ${33} | ${91}  | ${1}  | ${1}  | ${-99.837574}
      ${34} | ${27}  | ${0}  | ${27} | ${-126.229111}
      ${35} | ${67}  | ${5}  | ${9}  | ${-84.671533}
      ${36} | ${97}  | ${1}  | ${92} | ${30.350877}
      ${37} | ${92}  | ${60} | ${68} | ${58.954584}
      ${38} | ${89}  | ${6}  | ${9}  | ${-61.147046}
    `('candle #$index: expected $verified', ({ high, low, close, verified }) => {
      cci.onNewCandle({ high, low, close });
      const result = cci.getResult();
      if (isNaN(result) && isNaN(verified)) {
        expect(result).toBeNaN();
      } else {
        expect(result.toFixed(6)).toEqual(verified.toFixed(6));
      }
    });
  });
});
