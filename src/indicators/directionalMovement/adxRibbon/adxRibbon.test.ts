import { describe, expect, it } from 'vitest';
import { ADXRibbon } from './adxRibbon.indicator';

describe('ADXRibbon', () => {
  const ribbon = new ADXRibbon({ count: 5, start: 1, step: 2 });
  it.each`
    candle                                                                                      | expected
    ${{ close: 81, open: 81, high: 82.96289647361662, low: 79.03710352638338, volume: 403 }}    | ${null}
    ${{ close: 24, open: 81, high: 83.85720988022568, low: 21.142790119774318, volume: 814 }}   | ${null}
    ${{ close: 75, open: 24, high: 76.94326596315126, low: 22.056734036848734, volume: 1064 }}  | ${null}
    ${{ close: 21, open: 75, high: 79.67167346434113, low: 16.328326535658874, volume: 330 }}   | ${null}
    ${{ close: 34, open: 21, high: 34.711649023641215, low: 20.28835097635878, volume: 964 }}   | ${null}
    ${{ close: 25, open: 34, high: 36.18138133787512, low: 22.818618662124877, volume: 214 }}   | ${null}
    ${{ close: 72, open: 25, high: 73.33035016836122, low: 23.669649831638775, volume: 860 }}   | ${null}
    ${{ close: 92, open: 72, high: 94.97523624952838, low: 69.02476375047162, volume: 486 }}    | ${null}
    ${{ close: 99, open: 92, high: 101.5127586628106, low: 89.4872413371894, volume: 647 }}     | ${null}
    ${{ close: 2, open: 99, high: 99.0804764241746, low: 1.9195235758253941, volume: 396 }}     | ${null}
    ${{ close: 86, open: 2, high: 86.08306699694582, low: 1.916933003054178, volume: 252 }}     | ${null}
    ${{ close: 80, open: 86, high: 87.6552826540483, low: 78.3447173459517, volume: 299 }}      | ${null}
    ${{ close: 76, open: 80, high: 80.75068906338092, low: 75.24931093661908, volume: 469 }}    | ${null}
    ${{ close: 8, open: 76, high: 77.2154050332975, low: 6.784594966702496, volume: 605 }}      | ${null}
    ${{ close: 87, open: 8, high: 90.4594244098795, low: 4.540575590120497, volume: 261 }}      | ${null}
    ${{ close: 75, open: 87, high: 91.6843769949034, low: 70.3156230050966, volume: 926 }}      | ${null}
    ${{ close: 32, open: 75, high: 77.42509022428217, low: 29.57490977571783, volume: 544 }}    | ${null}
    ${{ close: 65, open: 32, high: 66.96254158787707, low: 30.037458412122934, volume: 819 }}   | ${{ results: [0, 69.8499157809925, 57.569217884024525, 47.99717570484244, 49.59638591814373], spread: 69.8499157809925 }}
    ${{ close: 41, open: 65, high: 69.41431179251751, low: 36.58568820748249, volume: 1012 }}   | ${{ results: [100, 68.44031108927717, 58.85213816142775, 49.970991225930874, 50.47262030548518], spread: 50.029008774069126 }}
    ${{ close: 9, open: 41, high: 43.081607806555546, low: 6.918392193444454, volume: 736 }}    | ${{ results: [100, 73.8390734285905, 62.20162587354286, 52.907699744935606, 52.0908173439492], spread: 47.9091826560508 }}
    ${{ close: 13, open: 9, high: 15.19184083967761, low: 6.808159160322391, volume: 971 }}     | ${{ results: [100, 77.45398706762083, 64.88851517124257, 55.429039294837175, 53.53209768714351], spread: 46.46790231285649 }}
    ${{ close: 26, open: 13, high: 28.498919258834377, low: 10.501080741165623, volume: 1098 }} | ${{ results: [100, 57.85371398848147, 60.569797352111294, 54.61329772554746, 53.134067556993905], spread: 46.865932443006095 }}
    ${{ close: 56, open: 26, high: 59.7249059948739, low: 22.2750940051261, volume: 379 }}      | ${{ results: [100, 54.39012073020428, 49.847480595878565, 48.553194747900974, 49.53715171897203], spread: 51.446805252099026 }}
    ${{ close: 28, open: 56, high: 58.44863123776439, low: 25.551368762235615, volume: 117 }}   | ${{ results: [0, 52.08105855801949, 41.26962719089238, 43.358820767061125, 46.33989319628592], spread: 52.08105855801949 }}
    ${{ close: 65, open: 28, high: 66.775319062114, low: 26.224680937886014, volume: 1041 }}    | ${{ results: [100, 54.92951637941276, 36.77973736585211, 37.57002461357287, 42.67075410972949], spread: 63.22026263414789 }}
    ${{ close: 58, open: 65, high: 68.65939501847261, low: 54.340604981527385, volume: 510 }}   | ${{ results: [100, 57.85712178181789, 33.75290335454175, 32.29177921665294, 39.21477939744913], spread: 67.70822078334706 }}
    ${{ close: 17, open: 58, high: 60.01918882495998, low: 14.980811175040019, volume: 878 }}   | ${{ results: [100, 56.1144491776789, 34.25692655527716, 32.654653881668345, 38.76013732322219], spread: 67.34534611833166 }}
    ${{ close: 90, open: 17, high: 93.37632122668938, low: 13.623678773310617, volume: 150 }}   | ${{ results: [100, 44.01376424776522, 29.28884239589429, 28.07450467436646, 35.31528832603742], spread: 71.92549532563353 }}
    ${{ close: 87, open: 90, high: 91.79876207396401, low: 85.20123792603599, volume: 914 }}    | ${{ results: [0, 35.946640961156106, 25.314375068387992, 24.14866249667913, 32.25320032853985], spread: 35.946640961156106 }}
    ${{ close: 86, open: 87, high: 90.67917429835809, low: 82.32082570164191, volume: 582 }}    | ${{ results: [100, 27.196686320758616, 21.187712110008828, 21.19520542086921, 29.753289884431524], spread: 78.81228788999117 }}
    ${{ close: 99, open: 86, high: 103.90666224637769, low: 81.09333775362231, volume: 804 }}   | ${{ results: [100, 32.43209913600673, 21.680006844762843, 19.657654483053463, 26.59060790670204], spread: 80.34234551694654 }}
    ${{ close: 3, open: 99, high: 100.63598126886475, low: 1.3640187311352432, volume: 436 }}   | ${{ results: [100, 43.94015292504123, 27.449400742975197, 23.02450704522374, 28.057289989299047], spread: 76.97549295477626 }}
    ${{ close: 70, open: 3, high: 74.01339408473842, low: -1.0133940847384295, volume: 747 }}   | ${{ results: [100, 51.978338454477715, 32.28131937291577, 26.045198074572742, 29.450803478632245], spread: 73.95480192542726 }}
    ${{ close: 1, open: 70, high: 70.62974231530183, low: 0.37025768469818, volume: 722 }}      | ${{ results: [0, 57.33712880743537, 36.146854276868225, 28.634361814014742, 30.68948213581731], spread: 57.33712880743537 }}
    ${{ close: 27, open: 1, high: 30.879348918826008, low: -2.879348918826009, volume: 221 }}   | ${{ results: [100, 61.89732335177519, 39.67117925677262, 31.092898880716408, 31.94030873152129], spread: 68.9071011192836 }}
    ${{ close: 9, open: 27, high: 29.207668220474442, low: 6.792331779525556, volume: 148 }}    | ${{ results: [0, 64.93745304800174, 42.49063924069613, 33.200216366460694, 33.05215459436927], spread: 64.93745304800174 }}
    ${{ close: 92, open: 9, high: 96.46225023362183, low: 4.5377497663781705, volume: 331 }}    | ${{ results: [100, 65.90787207055946, 41.40453550782607, 31.450573317660158, 30.598893330651187], spread: 69.40110666934882 }}
    ${{ close: 68, open: 92, high: 94.82774764949542, low: 65.17225235050458, volume: 338 }}    | ${{ results: [0, 66.55481808559794, 40.535652521530025, 29.950879275831127, 28.41821665179067], spread: 66.55481808559794 }}
    ${{ close: 9, open: 68, high: 69.94866467256739, low: 7.051335327432617, volume: 823 }}     | ${{ results: [100, 56.007918033645865, 37.17929926895017, 28.728532182629717, 27.612946871844642], spread: 72.38705312815536 }}
  `('returns $expected when candle.close = $candle.close', ({ candle, expected }) => {
    ribbon.onNewCandle(candle);
    const result = ribbon.getResult();
    if (expected === null) expect(result).toBeNull();
    else {
      expected.results.forEach((value, idx) => {
        expect(result.results[idx]).toBeCloseTo(value, 13);
      });
      expect(result.spread).toBeCloseTo(expected.spread, 13);
    }
  });
});
