import { describe, expect, it } from 'vitest';
import { OBV } from './obv.indicator';

describe('OBV', () => {
  const obv = new OBV({ period: 5 });
  it.each`
    candle                                                                                      | obv     | ma        | upper                 | lower
    ${{ close: 81, open: 81, high: 82.96289647361662, low: 79.03710352638338, volume: 403 }}    | ${null} | ${null}   | ${null}               | ${null}
    ${{ close: 24, open: 81, high: 83.85720988022568, low: 21.142790119774318, volume: 814 }}   | ${-814} | ${null}   | ${null}               | ${null}
    ${{ close: 75, open: 24, high: 76.94326596315126, low: 22.056734036848734, volume: 1064 }}  | ${250}  | ${null}   | ${null}               | ${null}
    ${{ close: 21, open: 75, high: 79.67167346434113, low: 16.328326535658874, volume: 330 }}   | ${-80}  | ${null}   | ${null}               | ${null}
    ${{ close: 34, open: 21, high: 34.711649023641215, low: 20.28835097635878, volume: 964 }}   | ${884}  | ${null}   | ${null}               | ${null}
    ${{ close: 25, open: 34, high: 36.18138133787512, low: 22.818618662124877, volume: 214 }}   | ${670}  | ${182}    | ${1380.743342004451}  | ${-1016.743342004451}
    ${{ close: 72, open: 25, high: 73.33035016836122, low: 23.669649831638775, volume: 860 }}   | ${1530} | ${650.8}  | ${1754.4132655962412} | ${-452.8132655962413}
    ${{ close: 92, open: 72, high: 94.97523624952838, low: 69.02476375047162, volume: 486 }}    | ${2016} | ${1004}   | ${2446.728526092141}  | ${-438.72852609214056}
    ${{ close: 99, open: 92, high: 101.5127586628106, low: 89.4872413371894, volume: 647 }}     | ${2663} | ${1552.6} | ${3015.2680279543956} | ${89.93197204560443}
    ${{ close: 2, open: 99, high: 99.0804764241746, low: 1.9195235758253941, volume: 396 }}     | ${2267} | ${1829.2} | ${3201.8035990044614} | ${456.5964009955387}
    ${{ close: 86, open: 2, high: 86.08306699694582, low: 1.916933003054178, volume: 252 }}     | ${2519} | ${2199}   | ${3000.683229212137}  | ${1397.3167707878629}
    ${{ close: 80, open: 86, high: 87.6552826540483, low: 78.3447173459517, volume: 299 }}      | ${2220} | ${2337}   | ${2793.9726468838153} | ${1880.027353116185}
    ${{ close: 76, open: 80, high: 80.75068906338092, low: 75.24931093661908, volume: 469 }}    | ${1751} | ${2284}   | ${2908.3973094112434} | ${1659.6026905887566}
    ${{ close: 8, open: 76, high: 77.2154050332975, low: 6.784594966702496, volume: 605 }}      | ${1146} | ${1980.6} | ${2951.572790555945}  | ${1009.6272094440544}
    ${{ close: 87, open: 8, high: 90.4594244098795, low: 4.540575590120497, volume: 261 }}      | ${1407} | ${1808.6} | ${2819.5627886326974} | ${797.6372113673025}
    ${{ close: 75, open: 87, high: 91.6843769949034, low: 70.3156230050966, volume: 926 }}      | ${481}  | ${1401}   | ${2568.8088884744798} | ${233.19111152552023}
    ${{ close: 32, open: 75, high: 77.42509022428217, low: 29.57490977571783, volume: 544 }}    | ${-63}  | ${944.4}  | ${2251.2555237668776} | ${-362.4555237668777}
    ${{ close: 65, open: 32, high: 66.96254158787707, low: 30.037458412122934, volume: 819 }}   | ${756}  | ${745.4}  | ${1773.6899202073314} | ${-282.88992020733133}
    ${{ close: 41, open: 65, high: 69.41431179251751, low: 36.58568820748249, volume: 1012 }}   | ${-256} | ${465}    | ${1655.2692132454742} | ${-725.2692132454742}
    ${{ close: 9, open: 41, high: 43.081607806555546, low: 6.918392193444454, volume: 736 }}    | ${-992} | ${-14.8}  | ${1203.5171344112337} | ${-1233.1171344112336}
    ${{ close: 13, open: 9, high: 15.19184083967761, low: 6.808159160322391, volume: 971 }}     | ${-21}  | ${-115.2} | ${1001.6494258403859} | ${-1232.049425840386}
    ${{ close: 26, open: 13, high: 28.498919258834377, low: 10.501080741165623, volume: 1098 }} | ${1077} | ${112.8}  | ${1587.3539800224337} | ${-1361.7539800224338}
    ${{ close: 56, open: 26, high: 59.7249059948739, low: 22.2750940051261, volume: 379 }}      | ${1456} | ${252.8}  | ${2043.970968947409}  | ${-1538.370968947409}
    ${{ close: 28, open: 56, high: 58.44863123776439, low: 25.551368762235615, volume: 117 }}   | ${1339} | ${571.8}  | ${2452.760350459307}  | ${-1309.1603504593072}
    ${{ close: 65, open: 28, high: 66.775319062114, low: 26.224680937886014, volume: 1041 }}    | ${2380} | ${1246.2} | ${2788.290736629982}  | ${-295.8907366299818}
    ${{ close: 58, open: 65, high: 68.65939501847261, low: 54.340604981527385, volume: 510 }}   | ${1870} | ${1624.4} | ${2536.851291850694}  | ${711.9487081493062}
    ${{ close: 17, open: 58, high: 60.01918882495998, low: 14.980811175040019, volume: 878 }}   | ${992}  | ${1607.4} | ${2562.197235019038}  | ${652.6027649809621}
    ${{ close: 90, open: 17, high: 93.37632122668938, low: 13.623678773310617, volume: 150 }}   | ${1142} | ${1544.6} | ${2569.686610974897}  | ${519.5133890251027}
    ${{ close: 87, open: 90, high: 91.79876207396401, low: 85.20123792603599, volume: 914 }}    | ${228}  | ${1322.4} | ${2807.742573280656}  | ${-162.94257328065555}
    ${{ close: 86, open: 87, high: 90.67917429835809, low: 82.32082570164191, volume: 582 }}    | ${-354} | ${775.6}  | ${2313.0397419086057} | ${-761.8397419086056}
    ${{ close: 99, open: 86, high: 103.90666224637769, low: 81.09333775362231, volume: 804 }}   | ${450}  | ${491.6}  | ${1572.2202663285561} | ${-589.0202663285562}
    ${{ close: 3, open: 99, high: 100.63598126886475, low: 1.3640187311352432, volume: 436 }}   | ${14}   | ${296}    | ${1294.4307687566525} | ${-702.4307687566525}
    ${{ close: 70, open: 3, high: 74.01339408473842, low: -1.0133940847384295, volume: 747 }}   | ${761}  | ${219.8}  | ${977.4578647384319}  | ${-537.857864738432}
    ${{ close: 1, open: 70, high: 70.62974231530183, low: 0.37025768469818, volume: 722 }}      | ${39}   | ${182}    | ${952.9910505317166}  | ${-588.9910505317166}
    ${{ close: 27, open: 1, high: 30.879348918826008, low: -2.879348918826009, volume: 221 }}   | ${260}  | ${304.8}  | ${860.80201438484}    | ${-251.20201438484008}
    ${{ close: 9, open: 27, high: 29.207668220474442, low: 6.792331779525556, volume: 148 }}    | ${112}  | ${237.2}  | ${788.3172651986145}  | ${-313.9172651986144}
    ${{ close: 92, open: 9, high: 96.46225023362183, low: 4.5377497663781705, volume: 331 }}    | ${443}  | ${323}    | ${840.9884168589101}  | ${-194.9884168589101}
    ${{ close: 68, open: 92, high: 94.82774764949542, low: 65.17225235050458, volume: 338 }}    | ${105}  | ${191.8}  | ${481.631399265159}   | ${-98.031399265159}
    ${{ close: 9, open: 68, high: 69.94866467256739, low: 7.051335327432617, volume: 823 }}     | ${-718} | ${40.4}   | ${837.7863304572006}  | ${-756.9863304572007}
  `(
    'should return expected results when candle close to $candle.close',
    ({ candle, obv: expectedObv, ma, upper, lower }) => {
      obv.onNewCandle(candle);
      const result = obv.getResult();
      if (expectedObv === null) expect(result.obv).toBeNull();
      else expect(result.obv).toBeCloseTo(expectedObv, 13);
      if (ma === null) expect(result.ma).toBeNull();
      else expect(result.ma).toBeCloseTo(ma, 13);
      if (upper === null) expect(result.upper).toBeNull();
      else expect(result.upper).toBeCloseTo(upper, 13);
      if (lower === null) expect(result.lower).toBeNull();
      else expect(result.lower).toBeCloseTo(lower, 13);
    },
  );
});
