import { each } from 'lodash-es';
import { describe, expect, it } from 'vitest';
import { EMA } from './ema.indicator';

// Fake input prices to verify all indicators
// are working correctly by comparing fresh
// calculated results to pre calculated results.

// The precalculated results are already compared
// to MS Excel results, more info here:
//
// https://github.com/askmike/gekko/issues/161

const candles = [
  { close: 81 },
  { close: 24 },
  { close: 75 },
  { close: 21 },
  { close: 34 },
  { close: 25 },
  { close: 72 },
  { close: 92 },
  { close: 99 },
  { close: 2 },
  { close: 86 },
  { close: 80 },
  { close: 76 },
  { close: 8 },
  { close: 87 },
  { close: 75 },
  { close: 32 },
  { close: 65 },
  { close: 41 },
  { close: 9 },
  { close: 13 },
  { close: 26 },
  { close: 56 },
  { close: 28 },
  { close: 65 },
  { close: 58 },
  { close: 17 },
  { close: 90 },
  { close: 87 },
  { close: 86 },
  { close: 99 },
  { close: 3 },
  { close: 70 },
  { close: 1 },
  { close: 27 },
  { close: 9 },
  { close: 92 },
  { close: 68 },
  { close: 9 },
];

describe('EMA', () => {
  const verified_ema10results = [
    81, 70.63636363636364, 71.42975206611571, 62.260706235912856, 57.12239601120143, 51.28196037280117,
    55.0488766686555, 61.76726272889996, 68.53685132364542, 56.439241992073526, 61.813925266241974, 65.12048430874343,
    67.09857807079008, 56.353382057919156, 61.925494411024765, 64.3026772453839, 58.429463200768645, 59.62410625517435,
    56.23790511786992, 47.64919509643902, 41.34934144254102, 38.55855208935174, 41.72972443674233, 39.23341090278918,
    43.91824528410024, 46.47856432335474, 41.11882535547206, 50.00631165447714, 56.73243680820857, 62.05381193398883,
    68.77130067326358, 56.81288236903384, 59.210540120118594, 48.6268055528243, 44.69465908867443, 38.204721072551806,
    47.985680877542386, 51.6246479907165, 43.87471199240441,
  ];
  const verified_ema12results = [
    81, 72.23076923076923, 72.65680473372781, 64.709604005462, 59.98504954308323, 54.602734228762735, 57.27923665510693,
    62.62089255432125, 68.2176783151949, 58.0303431897803, 62.33336731442949, 65.05131080451726, 66.73572452689922,
    57.69945921506857, 62.207234720442635, 64.17535245575915, 59.2252982317962, 60.11371388844294, 57.17314252099018,
    49.76188982545323, 44.106214467691196, 41.32064301112332, 43.57900562479666, 41.1822355286741, 44.84650698580116,
    46.870121295677905, 42.274718019419765, 49.617069093355184, 55.368289232839004, 60.08086012009454,
    66.06842010161846, 56.365586239831, 58.46318835678008, 49.62269784035237, 46.14228278799047, 40.42808543599194,
    48.36222613814703, 51.38342211689364, 44.862895637371544,
  ];
  const verified_ema26results = [
    81, 76.77777777777777, 76.64609053497942, 72.52415790275872, 69.67051657662844, 66.36158942280412,
    66.77924946555937, 68.64745320885127, 70.89579000819562, 65.79239815573669, 67.28925755160805, 68.23079402926672,
    68.80629076783956, 64.30212108133293, 65.98344544567864, 66.65133837562837, 64.08457257002627, 64.15238200928358,
    62.43739074933665, 58.47906550864504, 55.110245841338, 52.953931334572225, 53.179566050529836, 51.31441300974985,
    52.32816019421283, 52.74829647612299, 50.10027451492869, 53.055809736045084, 55.57019420004175, 57.824253888927544,
    60.87430915641439, 56.587323292976286, 57.580854900903965, 53.38968046379997, 51.434889318333305, 48.29156418364195,
    51.529226095964766, 52.7492834221896, 49.508595761286664,
  ];

  it.each`
    period | expected
    ${10}  | ${verified_ema10results}
    ${12}  | ${verified_ema12results}
    ${26}  | ${verified_ema26results}
  `('should correctly calculate EMAs with period $period', ({ period, expected }) => {
    const ema = new EMA({ period });
    each(candles, (candle, index) => {
      ema.onNewCandle(candle);
      expect(ema.getResult()).to.equal(expected[index]);
    });
  });
});
